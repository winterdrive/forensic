"""
å°‡BERTæ¨¡å‹è¼¸å‡ºçµæœèˆ‡LLMæ¨¡å‹åˆ¤æ–·é€²è¡Œæ¯”è¼ƒï¼Œä¸¦ç”Ÿæˆçµ±è¨ˆå ±å‘Šï¼Œä»¥åˆ©ç”¨LLMæª¢è¦–æˆ‘å€‘è¨“ç·´çš„bertæ¨¡å‹æ€§èƒ½ã€‚

input:
### bert result (generated by data_game_2025/src/bert_model/run_inference_simple.py)
data_game_2025/data/results/vote/candidates/both_multiligual_20250727_0100.csv
æª”æ¡ˆæ ¼å¼ç‚ºï¼š
| æ¬„ä½ | èªªæ˜ |
|------|------|
| `sms_id` | ç°¡è¨Š ID |
| `travel_prob` | æ—…éŠåˆ†é¡é æ¸¬æ©Ÿç‡ |
| `label` | æ—…éŠåˆ†é¡é æ¸¬çµæœï¼ˆ0: éæ—…éŠ, 1: æ—…éŠï¼‰|
| `name_prob` | å§“ååˆ†é¡é æ¸¬æ©Ÿç‡ |
| `name_flg` | å§“ååˆ†é¡é æ¸¬çµæœï¼ˆ0: éå§“å, 1: å§“åï¼‰|

### llm result (generated by data_game_2025/src/llm_name_classifier.py or data_game_2025/src/llm_travel_classifier.py)
data_game_2025/data/results/labled/stage2/magistral_more_10000/name_mistralai_magistral-small_20250721_1855.csv
æª”æ¡ˆæ ¼å¼ç‚ºï¼š
| æ¬„ä½ | èªªæ˜ |
|------|------|
| `sms_id` | ç°¡è¨Š ID |
| `name_flg` | å§“ååˆ†é¡é æ¸¬çµæœï¼ˆ0: éå§“å, 1: å§“åï¼‰|

data_game_2025/data/results/labled/stage2/magistral_more_10000/travel_mistralai_magistral-small_20250710_2231.csv
æª”æ¡ˆæ ¼å¼ç‚ºï¼š
| æ¬„ä½ | èªªæ˜ |
|------|------|
| `sms_id` | ç°¡è¨Š ID |
| `label` | æ—…éŠåˆ†é¡é æ¸¬çµæœï¼ˆ0: éæ—…éŠ, 1: æ—…éŠï¼‰|

output:
### llm compare resultï¼šç”¨æ–¼æŠ“å‡ºèˆ‡bertæ¨¡å‹é æ¸¬çµæœä¸ä¸€è‡´çš„æ¨£æœ¬ï¼Œä¸€è‡´çš„ä¸ç”¨è¨˜éŒ„
data_game_2025/data/results/vote/llm_compare_result.csv

æª”æ¡ˆæ ¼å¼ç‚ºï¼š
| æ¬„ä½ | èªªæ˜ |
|------|------|
| `sms_id` | ç°¡è¨Š ID |
| `travel_prob` | æ—…éŠåˆ†é¡é æ¸¬æ©Ÿç‡ |
| `label` | æ—…éŠåˆ†é¡é æ¸¬çµæœï¼ˆ0: éæ—…éŠ, 1: æ—…éŠï¼‰|
| `name_prob` | å§“ååˆ†é¡é æ¸¬æ©Ÿç‡ |
| `name_flg` | å§“ååˆ†é¡é æ¸¬çµæœï¼ˆ0: éå§“å, 1: å§“åï¼‰|
| `bert_travel_LLM` | LLMæ˜¯å¦é¸ä¸­ç‚ºæ—…éŠé¡åˆ¥ (1: é¸ä¸­, 0: æœªé¸ä¸­) |
| `bert_name_LLM` | LLMæ˜¯å¦é¸ä¸­ç‚ºå§“åé¡åˆ¥ (1: é¸ä¸­, 0: æœªé¸ä¸­) |
| `travel_conflict` | æ—…éŠåˆ†é¡è¡çªæ¨™è¨˜ (1: è¡çª, 0: ç„¡è¡çª) |
| `name_conflict` | å§“ååˆ†é¡è¡çªæ¨™è¨˜ (1: è¡çª, 0: ç„¡è¡çª) |
| `sms_body` | ç°¡è¨Šå…§å®¹(æºè‡ªdata_game_2025/data/raw/datagame_sms_stage1_raw_TEXT_ONLY.csv) |

"""

import pandas as pd
from pathlib import Path
import logging

# è¨­å®šæ—¥èªŒ
logging.basicConfig(
    level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)


class LLMBERTComparer:
    """LLM èˆ‡ BERT æ¨¡å‹çµæœæ¯”è¼ƒå™¨"""

    def __init__(self):
        """åˆå§‹åŒ–æ¯”è¼ƒå™¨"""
        # è¨­å®šæª”æ¡ˆè·¯å¾‘
        self.base_dir = Path(
            "/Users/winstontang/PycharmProjects/forensic/data_game_2025"
        )

        # BERT çµæœæª”æ¡ˆ
        self.bert_result_file = (
            self.base_dir
            / "data/results/vote/candidates/both_multiligual_20250727_0100.csv"
        )

        # LLM çµæœæª”æ¡ˆ
        self.llm_name_file = (
            self.base_dir
            / "data/results/labled/stage2/magistral_more_10000/name_mistralai_magistral-small_20250721_1855.csv"
        )
        self.llm_travel_file = (
            self.base_dir
            / "data/results/labled/stage2/magistral_more_10000/travel_mistralai_magistral-small_20250710_2231.csv"
        )

        # åŸå§‹ç°¡è¨Šå…§å®¹
        self.sms_content_file = (
            self.base_dir / "data/raw/datagame_sms_stage1_raw_TEXT_ONLY.csv"
        )

        # è¼¸å‡ºæª”æ¡ˆ
        self.output_file = self.base_dir / "data/results/vote/llm_compare_result.csv"

        logger.info("LLM-BERT æ¯”è¼ƒå™¨åˆå§‹åŒ–å®Œæˆ")

    def load_bert_results(self) -> pd.DataFrame:
        """è¼‰å…¥ BERT çµæœ"""
        logger.info("è¼‰å…¥ BERT çµæœ...")

        bert_df = pd.read_csv(self.bert_result_file)
        logger.info(f"è¼‰å…¥ BERT çµæœ: {len(bert_df)} ç­†")

        return bert_df

    def load_llm_results(self) -> tuple:
        """è¼‰å…¥ LLM çµæœ"""
        logger.info("è¼‰å…¥ LLM çµæœ...")

        # è¼‰å…¥å§“ååˆ†é¡çµæœ
        llm_name_df = pd.read_csv(self.llm_name_file)
        logger.info(f"è¼‰å…¥ LLM å§“ååˆ†é¡çµæœ: {len(llm_name_df)} ç­†")

        # è¼‰å…¥æ—…éŠåˆ†é¡çµæœ
        llm_travel_df = pd.read_csv(self.llm_travel_file)
        logger.info(f"è¼‰å…¥ LLM æ—…éŠåˆ†é¡çµæœ: {len(llm_travel_df)} ç­†")

        return llm_name_df, llm_travel_df

    def load_sms_content(self) -> pd.DataFrame:
        """è¼‰å…¥ç°¡è¨Šå…§å®¹"""
        logger.info("è¼‰å…¥ç°¡è¨Šå…§å®¹...")

        sms_df = pd.read_csv(self.sms_content_file)
        logger.info(f"è¼‰å…¥ç°¡è¨Šå…§å®¹: {len(sms_df)} ç­†")

        return sms_df

    def compare_results(self) -> pd.DataFrame:
        """æ¯”è¼ƒ BERT èˆ‡ LLM çµæœ"""
        logger.info("é–‹å§‹æ¯”è¼ƒ BERT èˆ‡ LLM çµæœ...")

        # è¼‰å…¥æ‰€æœ‰è³‡æ–™
        bert_df = self.load_bert_results()
        llm_name_df, llm_travel_df = self.load_llm_results()
        sms_df = self.load_sms_content()

        # å»ºç«‹ LLM é¸ä¸­çš„ sms_id é›†åˆ
        llm_travel_selected = set(llm_travel_df[llm_travel_df["label"] == 1]["sms_id"])
        llm_name_selected = set(llm_name_df[llm_name_df["name_flg"] == 1]["sms_id"])

        # åœ¨ BERT çµæœä¸­æ¨™è¨˜ LLM æ˜¯å¦é¸ä¸­
        bert_df["bert_travel_LLM"] = bert_df["sms_id"].apply(
            lambda x: 1 if x in llm_travel_selected else 0
        )
        bert_df["bert_name_LLM"] = bert_df["sms_id"].apply(
            lambda x: 1 if x in llm_name_selected else 0
        )

        # è¨ˆç®—è¡çª
        # æ—…éŠåˆ†é¡è¡çªï¼šBERT èªç‚ºæ˜¯æ—…éŠä½† LLM æœªé¸ä¸­ï¼Œæˆ– BERT èªç‚ºä¸æ˜¯æ—…éŠä½† LLM é¸ä¸­
        bert_df["travel_conflict"] = (
            (bert_df["label"] == 1) & (bert_df["bert_travel_LLM"] == 0)
        ) | ((bert_df["label"] == 0) & (bert_df["bert_travel_LLM"] == 1))

        # å§“ååˆ†é¡è¡çªï¼šBERT èªç‚ºæœ‰å§“åä½† LLM æœªé¸ä¸­ï¼Œæˆ– BERT èªç‚ºç„¡å§“åä½† LLM é¸ä¸­
        bert_df["name_conflict"] = (
            (bert_df["name_flg"] == 1) & (bert_df["bert_name_LLM"] == 0)
        ) | ((bert_df["name_flg"] == 0) & (bert_df["bert_name_LLM"] == 1))

        # è½‰æ›è¡çªæ¨™è¨˜ç‚ºæ•´æ•¸
        bert_df["travel_conflict"] = bert_df["travel_conflict"].astype(int)
        bert_df["name_conflict"] = bert_df["name_conflict"].astype(int)

        # åˆä½µç°¡è¨Šå…§å®¹
        if "sms_body" in sms_df.columns:
            sms_content_col = "sms_body"
        elif "body" in sms_df.columns:
            sms_content_col = "body"
        elif "text" in sms_df.columns:
            sms_content_col = "text"
        else:
            # å‡è¨­ç¬¬äºŒæ¬„æ˜¯ç°¡è¨Šå…§å®¹
            sms_content_col = sms_df.columns[1]

        # å‡è¨­ç¬¬ä¸€æ¬„æ˜¯ sms_id
        sms_id_col = sms_df.columns[0]

        # é‡æ–°å‘½åä»¥ä¾¿åˆä½µ
        sms_df_renamed = sms_df[[sms_id_col, sms_content_col]].rename(
            columns={sms_id_col: "sms_id", sms_content_col: "sms_body"}
        )

        # åˆä½µç°¡è¨Šå…§å®¹
        result_df = bert_df.merge(sms_df_renamed, on="sms_id", how="left")

        # çµ±è¨ˆè¡çªæƒ…æ³
        travel_conflicts = result_df["travel_conflict"].sum()
        name_conflicts = result_df["name_conflict"].sum()
        total_conflicts = (
            (result_df["travel_conflict"] == 1) | (result_df["name_conflict"] == 1)
        ).sum()

        logger.info(f"æ—…éŠåˆ†é¡è¡çª: {travel_conflicts} ç­†")
        logger.info(f"å§“ååˆ†é¡è¡çª: {name_conflicts} ç­†")
        logger.info(f"ç¸½è¡çªæ¨£æœ¬: {total_conflicts} ç­†")

        # åªè¿”å›æœ‰è¡çªçš„æ¨£æœ¬
        conflict_df = result_df[
            (result_df["travel_conflict"] == 1) | (result_df["name_conflict"] == 1)
        ]
        logger.info(f"ç¯©é¸å‡ºè¡çªæ¨£æœ¬: {len(conflict_df)} ç­†")

        return result_df, conflict_df

    def generate_conflict_analysis(self, result_df: pd.DataFrame) -> dict:
        """ç”Ÿæˆè¡çªåˆ†æçµ±è¨ˆ"""
        analysis = {}

        # åŸºæœ¬çµ±è¨ˆ
        analysis["total_samples"] = len(result_df)
        analysis["travel_conflicts"] = result_df["travel_conflict"].sum()
        analysis["name_conflicts"] = result_df["name_conflict"].sum()
        analysis["total_conflicts"] = (
            (result_df["travel_conflict"] == 1) | (result_df["name_conflict"] == 1)
        ).sum()

        # BERT é¸ä¸­çµ±è¨ˆ
        analysis["bert_travel_selected"] = (result_df["label"] == 1).sum()
        analysis["bert_name_selected"] = (result_df["name_flg"] == 1).sum()

        # LLM æ­£é¡çµ±è¨ˆ
        analysis["llm_travel_positive"] = result_df["bert_travel_LLM"].sum()
        analysis["llm_name_positive"] = result_df["bert_name_LLM"].sum()

        # ä¸€è‡´æ€§çµ±è¨ˆ
        analysis["travel_agreement"] = (
            analysis["total_samples"] - analysis["travel_conflicts"]
        )
        analysis["name_agreement"] = (
            analysis["total_samples"] - analysis["name_conflicts"]
        )

        # è¨ˆç®—ä¸€è‡´æ€§æ¯”ä¾‹
        analysis["travel_agreement_rate"] = (
            analysis["travel_agreement"] / analysis["total_samples"]
        )
        analysis["name_agreement_rate"] = (
            analysis["name_agreement"] / analysis["total_samples"]
        )

        return analysis

    def run_comparison(self) -> str:
        """åŸ·è¡Œå®Œæ•´çš„æ¯”è¼ƒæµç¨‹"""
        logger.info("é–‹å§‹åŸ·è¡Œ LLM-BERT æ¯”è¼ƒåˆ†æ")

        # åŸ·è¡Œæ¯”è¼ƒ
        result_df, conflict_df = self.compare_results()

        # ç”Ÿæˆåˆ†æçµ±è¨ˆï¼ˆåŸºæ–¼å®Œæ•´è³‡æ–™ï¼‰
        analysis = self.generate_conflict_analysis(result_df)

        # å„²å­˜è¡çªçµæœï¼ˆåªåŒ…å«æœ‰è¡çªçš„æ¨£æœ¬ï¼‰
        conflict_df.to_csv(self.output_file, index=False)
        logger.info(f"è¡çªæ¨£æœ¬å·²å„²å­˜è‡³: {self.output_file}")

        # è¼¸å‡ºçµ±è¨ˆæ‘˜è¦
        print("\n" + "=" * 60)
        print("ğŸ“Š LLM-BERT æ¯”è¼ƒåˆ†ææ‘˜è¦")
        print("=" * 60)
        print(f"ç¸½æ¨£æœ¬æ•¸: {analysis['total_samples']:,}")
        print(
            f"ç¸½è¡çªæ¨£æœ¬: {analysis['total_conflicts']:,} ({analysis['total_conflicts']/analysis['total_samples']*100:.1f}%)"
        )
        print(f"è¼¸å‡ºè¡çªæª”æ¡ˆ: {len(conflict_df):,} ç­†")
        print()
        print("ğŸ¯ æ—…éŠåˆ†é¡æ¯”è¼ƒ:")
        print(f"  BERT æ­£é¡: {analysis['bert_travel_selected']:,}")
        print(f"  LLM é¸ä¸­: {analysis['llm_travel_positive']:,}")
        print(f"  è¡çªæ•¸é‡: {analysis['travel_conflicts']:,}")
        print(f"  ä¸€è‡´æ€§: {analysis['travel_agreement_rate']*100:.1f}%")
        print()
        print("ğŸ‘¤ å§“ååˆ†é¡æ¯”è¼ƒ:")
        print(f"  BERT æ­£é¡: {analysis['bert_name_selected']:,}")
        print(f"  LLM é¸ä¸­: {analysis['llm_name_positive']:,}")
        print(f"  è¡çªæ•¸é‡: {analysis['name_conflicts']:,}")
        print(f"  ä¸€è‡´æ€§: {analysis['name_agreement_rate']*100:.1f}%")
        print("=" * 60)

        return str(self.output_file)


def main():
    """ä¸»å‡½æ•¸"""
    try:
        comparer = LLMBERTComparer()
        output_file = comparer.run_comparison()
        print(f"\nâœ… æ¯”è¼ƒåˆ†æå®Œæˆï¼çµæœæª”æ¡ˆ: {output_file}")

    except Exception as e:
        logger.error(f"åŸ·è¡Œå¤±æ•—: {str(e)}")
        raise


if __name__ == "__main__":
    main()
